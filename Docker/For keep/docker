#!/bin/bash
set -e

echo -e "\e[32mğŸš€ Starting OCPP Gateway...\e[0m"

# Stop any running containers
echo -e "\e[33mğŸ›‘ Stopping existing containers...\e[0m"
docker compose down --remove-orphans

# Build and start containers
echo -e "\e[36mğŸ”¨ Building and starting containers...\e[0m"
docker compose up --build -d

# Wait for containers to start
echo -e "\e[33mâ³ Waiting for containers to start...\e[0m"
sleep 15

# Check if containers are running
echo -e "\e[36mğŸ” Checking container status...\e[0m"
docker compose ps --format "table {{.Service}}\t{{.State}}"

# Wait for database to be ready
echo -e "\e[36mğŸ“¦ Waiting for database and running Prisma migrations...\e[0m"
echo -e "\e[90m   Checking database connectivity...\e[0m"

dbReady=false
dbAttempts=0
maxDbAttempts=30

while [ $dbAttempts -lt $maxDbAttempts ]; do
    dbAttempts=$((dbAttempts+1))
    echo -e "\e[90m   Database check attempt $dbAttempts/$maxDbAttempts...\e[0m"

    if docker compose exec -T postgres pg_isready -U postgres -d ocpp > /dev/null 2>&1; then
        echo -e "\e[32mâœ… Database is ready!\e[0m"
        dbReady=true
        break
    fi
    sleep 2
done

if [ "$dbReady" = false ]; then
    echo -e "\e[31mâŒ Database failed to become ready\e[0m"
    docker compose logs postgres
    exit 1
fi

# Run Prisma migrations with retries
maxAttempts=5
attempt=1
while [ $attempt -le $maxAttempts ]; do
    echo -e "\e[90m   Migration attempt $attempt/$maxAttempts...\e[0m"

    if docker compose exec -T ocpp-server npx prisma migrate deploy; then
        echo -e "\e[32mâœ… Prisma migrations completed successfully!\e[0m"
        break
    else
        echo -e "\e[33mâš ï¸  Migration attempt $attempt failed, retrying...\e[0m"
        sleep 5
        attempt=$((attempt+1))
    fi
done

if [ $attempt -gt $maxAttempts ]; then
    echo -e "\e[31mâŒ Prisma migrations failed after $maxAttempts attempts\e[0m"
    echo -e "\e[33mğŸ“‹ App container logs:\e[0m"
    docker compose logs ocpp-server
    exit 1
fi

# Final status check
echo ""
echo -e "\e[32mâœ… OCPP Gateway is up and running!\e[0m"
echo -e "\e[36mğŸŒ Access your application at: http://localhost:3000\e[0m"
echo ""
echo -e "\e[36mğŸ“Š Final Container Status:\e[0m"
docker compose ps
echo ""
echo -e "\e[90mğŸ“‹ Useful Commands:\e[0m"
echo -e "\e[90m   ğŸ” View all logs: docker compose logs -f\e[0m"
echo -e "\e[90m   ğŸ” View app logs: docker compose logs -f ocpp-server\e[0m"
echo -e "\e[90m   ğŸ›‘ Stop services: docker compose down\e[0m"
echo -e "\e[90m   ğŸ”„ Restart app: docker compose restart ocpp-server\e[0m"
